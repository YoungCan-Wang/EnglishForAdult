buildscript {
    ext {
        buildToolsVersion = "35.0.0"
        minSdkVersion = 24
        compileSdkVersion = 35
        targetSdkVersion = 30
        ndkVersion = "27.1.12297006"
        kotlinVersion = "1.9.10"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle")
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin")
    }
}

apply plugin: "com.facebook.react.rootproject"

// Add project-level properties for third-party libraries
project.ext.compileSdk = 35
project.ext.buildToolsVersion = "35.0.0"
project.ext.targetSdkVersion = 30

// Additional properties for compatibility
compileSdk = 35
buildToolsVersion = "35.0.0"
targetSdkVersion = 30

// Global React Native configuration
allprojects {
    ext {
        REACT_NATIVE_NODE_MODULES_DIR = file("${rootDir}/../node_modules/react-native")
    }

    // Android-first dependency resolution
    repositories {
        google()
        mavenCentral()
        maven { url "https://www.jitpack.io" }
        // ä¼˜å…ˆä½¿ç”¨ Maven ä»“åº“è€Œä¸æ˜¯ node_modules
        maven { url "https://maven.google.com" }
    }
}

// è‡ªåŠ¨åŒ–è„šæœ¬ä»»åŠ¡
task setupReactNativeDeps {
    description = "è‡ªåŠ¨è®¾ç½® React Native ä¾èµ–ï¼Œå‡å°‘æ‰‹åŠ¨ npm install"
    doLast {
        println "ðŸ”§ æ£€æŸ¥ React Native ä¾èµ–..."

        def nodeModulesDir = file("../node_modules")
        if (!nodeModulesDir.exists()) {
            println "ðŸ“¦ è‡ªåŠ¨æ‰§è¡Œ npm install..."
            exec {
                workingDir file("..")
                commandLine "npm", "install"
            }
        } else {
            println "âœ… node_modules å·²å­˜åœ¨"
        }

        // éªŒè¯å…³é”®ä¾èµ–
        def criticalDeps = [
            "react-native",
            "react-native-gesture-handler",
            "react-native-screens"
        ]

        criticalDeps.each { dep ->
            def depDir = file("../node_modules/${dep}")
            if (depDir.exists()) {
                println "âœ… ${dep} å·²å®‰è£…"
            } else {
                throw new GradleException("âŒ ç¼ºå°‘å…³é”®ä¾èµ–: ${dep}")
            }
        }
    }
}

// è®©æ‰€æœ‰æž„å»ºä»»åŠ¡ä¾èµ–äºŽä¾èµ–æ£€æŸ¥
tasks.whenTaskAdded { task ->
    if (task.name == 'preBuild') {
        task.dependsOn setupReactNativeDeps
    }
}

// å¼•å…¥æ™ºèƒ½æž„å»ºè„šæœ¬
apply from: 'smart_build.gradle'
