// Smart Build Script for React Native Android
// ç›®æ ‡ï¼šè®© Android å¼€å‘è€…èƒ½å¤Ÿæ›´ç›´æ¥åœ°æ„å»ºé¡¹ç›®

apply plugin: 'base'

// æ™ºèƒ½ä¾èµ–æ£€æŸ¥å’Œå®‰è£…
task smartSetup {
    group = 'react-native'
    description = 'æ™ºèƒ½è®¾ç½® React Native é¡¹ç›®ä¾èµ–'
    
    doLast {
        println "ğŸš€ Smart React Native Setup Starting..."
        
        // 1. æ£€æŸ¥ Node.js ç¯å¢ƒ
        try {
            exec {
                commandLine "node", "--version"
                standardOutput = new ByteArrayOutputStream()
            }
            println "âœ… Node.js ç¯å¢ƒæ­£å¸¸"
        } catch (Exception e) {
            throw new GradleException("âŒ éœ€è¦å®‰è£… Node.js: https://nodejs.org/")
        }
        
        // 2. æ£€æŸ¥å¹¶å®‰è£… npm ä¾èµ–
        def packageJson = file("../package.json")
        def nodeModules = file("../node_modules")
        
        if (!packageJson.exists()) {
            throw new GradleException("âŒ æ‰¾ä¸åˆ° package.json æ–‡ä»¶")
        }
        
        if (!nodeModules.exists() || nodeModules.listFiles().length == 0) {
            println "ğŸ“¦ è‡ªåŠ¨å®‰è£… npm ä¾èµ–..."
            exec {
                workingDir file("..")
                commandLine "npm", "install"
            }
        }
        
        // 3. éªŒè¯å…³é”® React Native ä¾èµ–
        def criticalDeps = [
            "react-native": "React Native æ ¸å¿ƒ",
            "react-native-gesture-handler": "æ‰‹åŠ¿å¤„ç†",
            "react-native-screens": "å±å¹•å¯¼èˆª",
            "@react-navigation/native": "å¯¼èˆªæ ¸å¿ƒ"
        ]
        
        criticalDeps.each { dep, desc ->
            def depPath = file("../node_modules/${dep}")
            if (depPath.exists()) {
                println "âœ… ${desc} (${dep})"
            } else {
                println "âš ï¸  ç¼ºå°‘ä¾èµ–: ${desc} (${dep})"
            }
        }
        
        // 4. è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜ï¼ˆç±»ä¼¼ä½ çš„è„šæœ¬ï¼‰
        fixReactNativeLinks()
        
        println "ğŸ‰ Smart Setup å®Œæˆï¼ç°åœ¨å¯ä»¥è¿è¡Œ './gradlew assembleDebug'"
    }
}

// è‡ªåŠ¨ä¿®å¤ React Native é“¾æ¥é—®é¢˜
def fixReactNativeLinks() {
    println "ğŸ”§ ä¿®å¤ React Native ä¾èµ–é“¾æ¥..."
    
    // ä¸º react-native-gesture-handler åˆ›å»ºé“¾æ¥
    def gestureHandlerDir = file("../node_modules/react-native-gesture-handler")
    if (gestureHandlerDir.exists()) {
        def gestureNodeModules = file("../node_modules/react-native-gesture-handler/node_modules")
        gestureNodeModules.mkdirs()
        
        def reactAndroidLink = file("../node_modules/react-native-gesture-handler/node_modules/ReactAndroid")
        def reactAndroidSource = file("../node_modules/react-native/ReactAndroid")
        
        if (reactAndroidSource.exists() && !reactAndroidLink.exists()) {
            // åˆ›å»ºç¬¦å·é“¾æ¥æˆ–å¤åˆ¶
            try {
                exec {
                    commandLine "ln", "-sf", reactAndroidSource.absolutePath, reactAndroidLink.absolutePath
                }
                println "âœ… react-native-gesture-handler é“¾æ¥å·²ä¿®å¤"
            } catch (Exception e) {
                println "âš ï¸  æ— æ³•åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
            }
        }
    }
}

// æ™ºèƒ½æ„å»ºä»»åŠ¡
task smartBuild {
    group = 'react-native'
    description = 'æ™ºèƒ½æ„å»º React Native Android åº”ç”¨'
    dependsOn smartSetup
    
    doLast {
        println "ğŸ—ï¸  å¼€å§‹æ™ºèƒ½æ„å»º..."
        exec {
            commandLine "./gradlew", "assembleDebug"
        }
    }
}

// æ¸…ç†ä»»åŠ¡
task smartClean {
    group = 'react-native'
    description = 'æ™ºèƒ½æ¸…ç†é¡¹ç›®'
    
    doLast {
        println "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
        
        // æ¸…ç† Gradle
        exec {
            commandLine "./gradlew", "clean"
        }
        
        // å¯é€‰ï¼šæ¸…ç† node_modules
        println "æ˜¯å¦è¦æ¸…ç† node_modules? (è¿™å°†éœ€è¦é‡æ–° npm install)"
        // è¿™é‡Œå¯ä»¥æ·»åŠ äº¤äº’å¼é€‰æ‹©
    }
}

// é¡¹ç›®çŠ¶æ€æ£€æŸ¥
task projectStatus {
    group = 'react-native'
    description = 'æ£€æŸ¥é¡¹ç›®çŠ¶æ€'
    
    doLast {
        println "ğŸ“Š React Native é¡¹ç›®çŠ¶æ€æ£€æŸ¥"
        println "================================"
        
        // æ£€æŸ¥ package.json
        def packageJson = file("../package.json")
        if (packageJson.exists()) {
            println "âœ… package.json å­˜åœ¨"
        } else {
            println "âŒ package.json ä¸å­˜åœ¨"
        }
        
        // æ£€æŸ¥ node_modules
        def nodeModules = file("../node_modules")
        if (nodeModules.exists()) {
            def depCount = nodeModules.listFiles()?.length ?: 0
            println "âœ… node_modules å­˜åœ¨ (${depCount} ä¸ªä¾èµ–)"
        } else {
            println "âŒ node_modules ä¸å­˜åœ¨"
        }
        
        // æ£€æŸ¥ Android é…ç½®
        def buildGradle = file("app/build.gradle")
        if (buildGradle.exists()) {
            println "âœ… Android æ„å»ºé…ç½®å­˜åœ¨"
        } else {
            println "âŒ Android æ„å»ºé…ç½®ä¸å­˜åœ¨"
        }
        
        println "================================"
        println "ğŸ’¡ å»ºè®®çš„æ„å»ºæµç¨‹ï¼š"
        println "1. ./gradlew smartSetup    # æ™ºèƒ½è®¾ç½®"
        println "2. ./gradlew smartBuild    # æ™ºèƒ½æ„å»º"
        println "æˆ–è€…ç›´æ¥: ./gradlew assembleDebug"
    }
}